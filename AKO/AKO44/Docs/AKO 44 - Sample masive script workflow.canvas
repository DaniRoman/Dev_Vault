{
	"nodes":[
		{"id":"48300c02ca37240c","type":"text","text":"```js\nconst amqp = require(\"amqplib\");\n\nasync function main() {\n  // -----------------------------\n  // 1) Argumentos de entrada\n  // -----------------------------\n  // Aqui comprobamos que el script tengo un arguemnto [0] ruta [1] nombreScript [2] arguemnto\n  if (!process.argv[2]) {\n    console.error(\"Error: Debes proporcionar el número de mensajes\");\n    console.error(\"Uso: node pub.js <numero_de_mensajes> [minidelay_ms]\");\n    console.error(\"Ejemplo: node pub.js 5000 10\");\n    process.exit(1);\n  }\n  //\n  //Pasamos el argumento a INT de base 10\n  const numMessages = parseInt(process.argv[2], 10);\n  // Si existe el argumento 3 (El deelay) se pasa a INT base 10 y se setea por defecto a 100ms 0,1s\n  const minDelayMs = process.argv[3] ? parseInt(process.argv[3], 10) : 100;\n\n// Si numMessages no es un numero o es mas pequeño o igual a 0 Errores \n  if (isNaN(numMessages) || numMessages <= 0) {\n    console.error(\"Error: El número de mensajes debe ser un número positivo\");\n    console.error(\"Ejemplo: node pub.js 5000 10\");\n    process.exit(1);\n  }\n  //Si minDelayMs no es un numero o es mas pequeño o igual a 0 Errores \n  if (isNaN(minDelayMs) || minDelayMs < 0) {\n    console.error(\"Error: minidelay_ms debe ser un número entero >= 0\");\n    console.error(\"Ejemplo: node pub.js 5000 10\");\n    process.exit(1);\n  \n  console.log(`Generando ${numMessages} mensajes (minidelay=${minDelayMs} ms)...`);\n  // ----------------------------\n  // 2) Conexión a RabbitMQ\n  // -----------------------------\n  const connection = await amqp.connect(\"amqp://localhost\");\n  const channel = await connection.createChannel();\n  const exchange = \"akocloud\";\n  const routingKey = \"driver.input.perte\";\n  await channel.assertExchange(exchange, \"topic\", { durable: true });\n  // -----------------------------\n  // 3) Base de info fija (device + conexión)\n  // -----------------------------\n  const baseDeviceInformation = {\n    serialNumber: 974130021,\n    device: {\n      _id: \"6989bc8e59e52a4bafd618a9\",\n      _companyId: \"5ab8a13370f53c000bc46384\",\n      commercialVersion: \"AKO-D14123N\",\n      firmwareVersion: 6402,\n      deviceDefinition: \"6981e314cc2593f5137d03e4\",\n      modemModel: \"Quectel_BC660K-GL\",\n      created_at: \"2025-04-15T08:15:08.853Z\",\n      model: \"panel_1ry_6402\",\n      ip: \"10.10.2.201\",\n    },\n    existsInDevice: true,\n    existsInManufactured: true,\n    license: true,\n    uuid: \"2E19CFDA300B3F385A343536754B33324B572E7E\",\n  };\n  const baseInfo = { address: \"10.10.2.201\" };\n  // -----------------------------\n  // 4) Generación de payloads\n  // -----------------------------\n  const payloads = [];\n  const nowInSeconds = Math.floor(Date.now() / 1000);\n\n  console.log(\n    `Timestamp inicial: ${nowInSeconds} (${new Date(nowInSeconds * 1000).toISOString()})`\n  );\n\n  for (let i = 0; i < numMessages; i++) {\n    // retrocede 5 minutos por cada mensaje (300s)\n    const timestamp = nowInSeconds - i * 300;\n    // Genera temp1/temp2 con distribución:\n    // 50% entre 0 y 2, 25% < -3, 25% > 3 (valores “x10”)\n    const rand = Math.random();\n    let temp1, temp2;\n\n    if (rand < 0.5) {\n      temp1 = Math.floor(Math.random() * 20); // 0.0°C - 2.0°C (x10)\n      temp2 = Math.floor(Math.random() * 20);\n    } else if (rand < 0.75) {\n      temp1 = Math.floor(-30 - Math.random() * 50); // -3.0°C a -8.0°C (x10)\n      temp2 = Math.floor(-30 - Math.random() * 50);\n    } else {\n      temp1 = Math.floor(30 + Math.random() * 70); // 3.0°C a 10.0°C (x10)\n      temp2 = Math.floor(30 + Math.random() * 70);\n    }\n    const temp3 = 0;\n    // Digitales (valores/counters)\n    const d1_val = 1;\n    const d2_val = i % 2;\n    const d3_val = Math.random() > 0.5 ? 1 : 0;\n    const d4_val = Math.random() > 0.5 ? 1 : 0;\n    const d5_val = Math.random() > 0.5 ? 1 : 0;\n    const d6_val = Math.random() > 0.5 ? 1 : 0;\n\n    const d1_cnt = 0;\n    const d2_cnt = 0;\n    const d3_cnt = Math.floor(Math.random() * 6);\n    const d4_cnt = Math.floor(Math.random() * 6);\n    const d5_cnt = Math.floor(Math.random() * 6);\n    const d6_cnt = Math.floor(Math.random() * 6);\n\n    // Payload tipo \"sample\"\n    payloads.push({\n      id: [2026200100007, 6402, 1, 26, 0],\n      ty: \"sample\",\n      li: 1,\n      d: [[timestamp, temp1, 1, 1, temp2, 2, 1, temp3, 1, 1]],\n      d1: [\n        [\n          timestamp,\n          d1_val, d1_cnt,\n          d2_val, d2_cnt,\n          d3_val, d3_cnt,\n          d4_val, d4_cnt,\n          d5_val, d5_cnt,\n          d6_val, d6_cnt,\n        ],\n      ],\n    });\n  }\n  // -----------------------------\n  // 5) Publicación de mensajes\n  // -----------------------------\n  for (let i = 0; i < payloads.length; i++) {\n    const message = {\n      deviceInformation: baseDeviceInformation,\n      payload: payloads[i],\n      info: baseInfo,\n    };\n    channel.publish(exchange, routingKey, Buffer.from(JSON.stringify(message)));\n    // Delay opcional entre mensajes\n    if (minDelayMs > 0) {\n      await new Promise((resolve) => setTimeout(resolve, minDelayMs));\n    }\n    // Progreso en la misma línea\n    process.stdout.write(`\\rsended ${i + 1}/${payloads.length}`);\n    // Log “persistente” cada 1000\n    if ((i + 1) % 1000 === 0) {\n      console.log(`\\nPublicados ${i + 1} de ${payloads.length} mensajes...`);\n      process.stdout.write(`\\rsended ${i + 1}/${payloads.length}`);\n    }\n  }\n  // -----------------------------\n  // 6) Cierre de recursos\n  // -----------------------------\n  await channel.close();\n  await connection.close();\n\n  process.stdout.write(\"\\n\");\n  console.log(`Todos los ${payloads.length} mensajes han sido publicados.`);\n}\nmain().catch((error) => {\n  console.error(`An error occurred: ${error.message}`);\n});\n```","x":-391,"y":-503,"width":871,"height":703},
		{"id":"323707537d8dd724","type":"text","text":"[[JavaScript#^eaec43]]","x":-960,"y":-466,"width":250,"height":60},
		{"id":"5d1adf8352355307","type":"text","text":">[!tip] `base 10`\n>\n\n`arseInt(cadena, 10)`, ese **10** le dice a JavaScript:\n>“interpreta la cadena como un número en **base 10**”.\n¿Por qué importa? Porque una misma cadena puede significar otra cosa en otras bases\n- Base 10: `\"10\"` = **10**\n- Base 2 (binario): `\"10\"` = **2**\n- Base 16 (hex): `\"10\"` = **16**","x":-1390,"y":-261,"width":680,"height":134},
		{"id":"114772314b8db986","type":"text","text":"\n[[JavaScript#^0655fa]]\n\n- `Date.now()` devuelve el tiempo actual en **milisegundos** desde el 1/1/1970 (Unix epoch).\n    \n- Al dividir entre `1000`, lo conviertes a **segundos**.\n    \n- `Math.floor(...)` quita los decimales y deja un **entero**.\n    \n\nEn resumen: te da el **timestamp Unix en segundos** (ej. `1700000000`), útil para guardarlo/enviarlo en formatos compactos.","x":-1240,"y":200,"width":510,"height":120},
		{"id":"4dbc950a7979ee68","type":"text","text":"[[JavaScript#^fb6174]]","x":-980,"y":0,"width":250,"height":60},
		{"id":"3c222aae4d0f4262","x":-753,"y":368,"width":613,"height":252,"type":"text","text":"En caso del 1 Rele\n\n- <d1_v(K)>: digital value (1) of the variable k (current digital value: 0 / 1) \n\tEstado actual \n- <d1_c(K)>: digital counter (1) of the variable k.\n\t- Contador de cambios de estados\n- (k) tantos como elementos tenga "},
		{"id":"9204ce8240a39e22","x":-753,"y":720,"width":613,"height":280,"type":"text","text":"“d”: data -  sample data array where: \n\n- <ts>:  sample time stamp (UTC) in seconds. \n    \n\n- <s1_v(k)>: sample (1) of the variable k (analog vars samples at the timestamp “ts”)  \n    \n\n- <s1_unit(k)>: unit of the variable k in the sample 1 \n    \n\n- <s1_decimals(k)>: decimal places of the variable k in the sample\nvalor unidades decimales  para cada uno"},
		{"id":"d9ddd7569b7736ff","x":-82,"y":293,"width":502,"height":387,"type":"text","text":"d hace referencia a la sonda analogica y d1 a la digital\n![[Pasted image 20260224164121.png]]"}
	],
	"edges":[
		{"id":"328826234f0ffc9d","fromNode":"48300c02ca37240c","fromSide":"left","toNode":"5d1adf8352355307","toSide":"right","label":"parseInt(n, n)"},
		{"id":"3172bec515c78f2b","fromNode":"48300c02ca37240c","fromSide":"left","toNode":"323707537d8dd724","toSide":"right","label":"Nan"},
		{"id":"0f00f9640a72ff44","fromNode":"48300c02ca37240c","fromSide":"left","toNode":"4dbc950a7979ee68","toSide":"right","label":"Math.floor"},
		{"id":"37ed8e65e995678c","fromNode":"48300c02ca37240c","fromSide":"left","toNode":"114772314b8db986","toSide":"right","label":"DateNow( )"}
	]
}